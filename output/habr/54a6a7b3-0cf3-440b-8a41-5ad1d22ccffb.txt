<div>
 <div class="article-formatted-body article-formatted-body article-formatted-body_version-2">
  <div xmlns="http://www.w3.org/1999/xhtml">
   <p>Всего 10&nbsp;лет назад в&nbsp;качестве дипломного проекта можно&nbsp;было представить сверстанный с&nbsp;нуля сайт, а&nbsp;лендинг мог считаться уровнем выпускника вуза. Сейчас&nbsp;же комиссию в&nbsp;среднем профессиональном образовании трудно удивить и серверным веб‑приложением со сложной архитектурой и потоковым обменом данных. Преподаватель Казанского техникума связи Вадим Начаров рассказывает в&nbsp;статье, как&nbsp;отбираются варианты проектов, что&nbsp;делать, если бюджет ограничен упаковкой печенек, и как&nbsp;написать диплом, чтобы&nbsp;были довольны и преподаватели, и выпускники.</p>
   <figure class="full-width ">
    <img src="https://habrastorage.org/getpro/habr/upload_files/5f9/4d2/4d2/5f94d24d27fcc279e7bf0e90c7639578.JPG" width="2048" height="1369">
    <figcaption></figcaption>
   </figure>
   <p>Уровень выпускников растет вслед за&nbsp;технологиями и ежегодно прыгать выше головы начинает входить в&nbsp;привычку. А&nbsp;мне как&nbsp;руководителю выпускных проектов, нужно делать всё необходимое, чтобы этот прыжок удался легко и&nbsp;желательно без&nbsp;травм. Итак, отгремели новогодние каникулы, стартовал итоговый семестр и ко мне пришли два выпускника с&nbsp;целью определить направления и цели своих работ.</p>
   <p>После проведенного брейнсторма, анализа работ предыдущих лет, и с&nbsp;учетом интересом и увлечений ребят,&nbsp;было решено разрабатывать игру. Да&nbsp;не&nbsp;простую, а&nbsp;сетевую! Чтобы вот через эти ваши интернеты соединение&nbsp;было, а&nbsp;не&nbsp;по&nbsp;локалке, в&nbsp;рамках одной машины.</p>
   <p>Для&nbsp;того, чтобы реализовать многопользовательский режим, нужен сервер. Для&nbsp;того, чтобы сервер правильно работал, нужен программист хорошего уровня, и, к&nbsp;сожалению, наш бюджет в&nbsp;виде стикеров с&nbsp;аниме персонажами и упаковки печенек никого не&nbsp;привлекал.</p>
   <p>Разумеется, студенты начали искать более дешевые варианты решения проблем. Найти&nbsp;ответ помогли различные мессенджеры, работающие на&nbsp;технологии Peer2Peer, а&nbsp;конкретно Client‑Server Host.</p>
   <blockquote>
    <p>Пару слов о технологии, если <em>вдруг </em>вы о ней не знаете.</p>
    <p>В отличие от классической клиент-серверной архитектуры, где связующим звеном является большой, мощный, дорогущий компьютер с быстрым интернетом, Р2Р позволила обойтись маленьким мощным компьютером с быстрым интернетом. Сам игрок является хостом, к которому подключаются другие, и на его железо ляжет выполнение основного кода игры.</p>
   </blockquote>
   <p>Из&nbsp;многообразия инструментальных средств, работающих по&nbsp;Р2Р технологии, студенты остановились на&nbsp;библиотеке <em>Netcode for GameObject</em>. Это бесплатная сетевая библиотека с&nbsp;открытым исходным кодом, которая предлагает широкий спектр функций, такие как&nbsp;сетевые переменные, управление сценами, вызов удаленных вызовов процедур. Библиотека подходит для&nbsp;клиент‑серверной и клиент‑сервер хост архитектуры.</p>
   <p>Сервер ретрансляции используется для&nbsp;передачи данных между двумя игроками. Клиенты будут отправлять пакеты друг другу, отправляя их на&nbsp;сервер ретрансляции и указывая, кому их перенаправить.</p>
   <p>Преимущество по&nbsp;сравнению с&nbsp;подходом перенаправления портов в&nbsp;том, что&nbsp;подключение к&nbsp;серверу ретрансляции всегда будет работать для&nbsp;любого клиента.</p>
   <p>Компания Unity предлагает сервис Relay, который выполняет функции сервера ретранслятора. Сейчас сервис не&nbsp;взимает плату за&nbsp;его использование. Реализация запуска, подключения к&nbsp;сервису Relay находятся в&nbsp;скрипте RelayManager.</p>
   <p><strong>Сервис Relay включает в&nbsp;себя два основных компонента: Relay Server и Allocation [13]:</strong></p>
   <ul>
    <li><p>Relay Server подключается к&nbsp;низкоуровневому слою Unity Transport и передает данные между клиентами;</p></li>
    <li><p>Сервис Allocation работает на&nbsp;стороне сервера. Он позволяет игрокам создавать матчи и подключаться к&nbsp;ним с&nbsp;помощью кодов доступа.</p></li>
   </ul>
   <p>В&nbsp;объекте NetPortals находятся три скрипта, которые описывают действия, происходящие при&nbsp;подключении, отключении клиентов (рис. 1):</p>
   <ul>
    <li><p>GameNetPortal является общей точкой входа для&nbsp;игровых сетевых сообщений между клиентом и сервером;</p></li>
    <li><p>ClientGameNetPortal является реализацией логики GameNetPortal на&nbsp;стороне клиента и добавление логики для&nbsp;клиента;</p></li>
    <li><p>ServerGameNetPortal является реализацией логики GameNetPortal на&nbsp;стороне сервера и добавление логики для&nbsp;сервера;</p></li>
   </ul>
   <figure class="full-width ">
    <img src="https://habrastorage.org/r/w780q1/getpro/habr/upload_files/8d1/3e8/b3e/8d13e8b3e57a4f35427246469ce2c9cf.jpg" alt=" Объект NetPortals" title=" Объект NetPortals" width="781" height="341" data-src="https://habrastorage.org/getpro/habr/upload_files/8d1/3e8/b3e/8d13e8b3e57a4f35427246469ce2c9cf.jpg" data-blurred="true">
    <figcaption>
     Объект NetPortals
    </figcaption>
   </figure>
   <p>Объект PlayerArmature отвечает за&nbsp;поведение и логику игрока на&nbsp;игровом поле. К&nbsp;нему подключены скрипты NetworkObject, NetworkAnimator, ClientNetworkTransform, ThirdPersonController. Скрипт NetworkObject требуется для&nbsp;всех сетевых объектов, чтобы использовать сетевые компоненты у&nbsp;объекта. NetworkAnimator синхронизирует анимацию по&nbsp;сети. ClientNetworkTransform синхронизирует положение, поворот в&nbsp;реальном времени во&nbsp;время игры. Скрипт ThirdPersonController отвечает за&nbsp;всё поведение игрока.</p>
   <p>Для&nbsp;оповещения изменений, которые случились с&nbsp;клиентом, и о&nbsp;которых должны узнать остальные клиенты, используется удаленный вызов процедур (RPC) и реплицированное состояние (NetworkVarible).</p>
   <p>Концепция RPC распространена не&nbsp;только в&nbsp;видеоиграх, но&nbsp;и в&nbsp;индустрии программного обеспечения в&nbsp;целом. Это способы вызова методов для&nbsp;объектов, находящихся в&nbsp;разных исполняемых файлах.</p>
   <p>Клиентские RPC могут&nbsp;быть вызваны как&nbsp;клиентом, так и сервером. Так как&nbsp;хост является одновременно и клиентом, и сервером, то при&nbsp;вызове команды клиентского RPC эта команда будет выполняться так&nbsp;же и у&nbsp;других клиентов. Таким образом, действия одного игрока на&nbsp;одной стороне будут спроецированы у&nbsp;всех игроков.</p>
   <figure class="full-width ">
    <img src="https://habrastorage.org/r/w780q1/getpro/habr/upload_files/19c/196/e16/19c196e1607a888292ec16bfde6d9d7c.jpg" width="988" height="421" data-src="https://habrastorage.org/getpro/habr/upload_files/19c/196/e16/19c196e1607a888292ec16bfde6d9d7c.jpg" data-blurred="true">
    <figcaption></figcaption>
   </figure>
   <p>Клиенты могут вызывать серверные RPC на&nbsp;хосте так&nbsp;же, как&nbsp;они могут вызывать серверные RPC на&nbsp;обычных серверах: RPC будет помещен в&nbsp;локальную очередь, а&nbsp;затем отправлен на&nbsp;хост, где он будет выполнен на&nbsp;версии того&nbsp;же NetworkObject на&nbsp;хосте.</p>
   <figure class="full-width ">
    <img src="https://habrastorage.org/r/w780q1/getpro/habr/upload_files/a86/c85/bf8/a86c85bf89732f9236cbedc7de240611.jpg" width="1004" height="428" data-src="https://habrastorage.org/getpro/habr/upload_files/a86/c85/bf8/a86c85bf89732f9236cbedc7de240611.jpg" data-blurred="true">
    <figcaption></figcaption>
   </figure>
   <p>Когда серверный RPC вызывается хостом, то он помещается в&nbsp;локальную очередь, а&nbsp;затем выполняется на&nbsp;хосте после небольшой задержки.</p>
   <figure class="full-width ">
    <img src="https://habrastorage.org/r/w780q1/getpro/habr/upload_files/c9b/610/cb5/c9b610cb5bcc6802414d1f99f1bf5be5.jpg" width="1004" height="428" data-src="https://habrastorage.org/getpro/habr/upload_files/c9b/610/cb5/c9b610cb5bcc6802414d1f99f1bf5be5.jpg" data-blurred="true">
    <figcaption></figcaption>
   </figure>
   <p>RPC отлично подходит для&nbsp;отправки временных событий. При&nbsp;выполнении какого‑либо действия игрока, использующего анимацию, вызывается клиентом серверное RPC, обновляющее анимации игрока для&nbsp;всех клиентов.</p>
   <h3>Итоги</h3>
   <p>После кропотливой работы с&nbsp;движком, а&nbsp;также реализации сетевого взаимодействия на&nbsp;основе Р2Р нам удалось запустить игровую сессию на&nbsp;четырех игроков.</p>
   <p>Несмотря на&nbsp;то, что&nbsp;процесс соединения осуществлялся на&nbsp;основе специального кода, генерируемого игроком сервером, сама возможность соединения без&nbsp;использования проводов или&nbsp;локалки произвела положительное впечатление на&nbsp;дипломную комиссию.</p>
   <p>На&nbsp;последующих скринах представлены:</p>
   <ul>
    <li><p>Окно для&nbsp;входа в&nbsp;открытую игровую сессию по&nbsp;коду.</p></li>
   </ul>
   <figure class="full-width ">
    <img src="https://habrastorage.org/r/w780q1/getpro/habr/upload_files/f0f/240/a72/f0f240a72f32ed98a89704b24f763345.jpg" width="982" height="481" data-src="https://habrastorage.org/getpro/habr/upload_files/f0f/240/a72/f0f240a72f32ed98a89704b24f763345.jpg" data-blurred="true">
    <figcaption></figcaption>
   </figure>
   <ul>
    <li><p>Окно клиента‑хоста, который создал сессию.</p></li>
   </ul>
   <figure class="full-width ">
    <img src="https://habrastorage.org/r/w780q1/getpro/habr/upload_files/2b5/bbd/d0d/2b5bbdd0dca690fcf0ed194735e69367.jpg" width="1003" height="490" data-src="https://habrastorage.org/getpro/habr/upload_files/2b5/bbd/d0d/2b5bbdd0dca690fcf0ed194735e69367.jpg" data-blurred="true">
    <figcaption></figcaption>
   </figure>
   <h3>Заключение</h3>
   <p>Проект&nbsp;был принят, студенты получили «отлично» и оставили после себя не&nbsp;только приятное впечатление о&nbsp;профессионализме выпускников <abbr class="habraabbr" title="среднее профессиональное образование" data-title="<p>среднее профессиональное образование</p>" data-abbr="СПО">СПО</abbr>, но&nbsp;и вызов. Вызов для&nbsp;меня и для&nbsp;моих будущих дипломников. Что&nbsp;ж, будем заново учиться прыгать выше головы.</p>
   <p></p>
  </div>
 </div>
</div> <!----> <!---->