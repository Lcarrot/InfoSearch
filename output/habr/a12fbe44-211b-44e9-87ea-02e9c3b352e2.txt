<div>
 <div class="article-formatted-body article-formatted-body article-formatted-body_version-2">
  <div xmlns="http://www.w3.org/1999/xhtml">
   <p>Не так давно, по случаю, мне достался ноутбук. Скончался от болезни человек, с которым я был в хороших отношениях. Спустя какое то время родственники приятеля начали распродавать и раздавать имущество умершего. Мне отдали ноутбук. Ноут Acer, не особо новый и не дорогой, особой ценности не представляет, отдали бесплатно. Но попросили по возможности достать оттуда данные - старые фото и видео на память. На ноутбуке установлена десятка и учетка с паролем, которого никто не знал. Делаю загрузочную флешку, цепляю съемный диск. Готово. В процессе копирования посмотрел, что еще есть на диске. Текстовые файлы с паролями, профиль браузера, какая то рабочая документация, личные заметки и т.д. Ненужно и не интересно. Фото и видео отдал родственникам. Диск отформатировал. Ноут в кладовку.</p>
   <p>Но в процессе ковыряния ноутбука, у меня появилась мысль. А хотелось бы мне, что бы в подобной ситуации кто то, так же лазил в моем ноутбуке. Нет, мне бы очень этого не хотелось. Несмотря на то, что там нет чего-то компрометирующего и критически важного для меня и моих близких. Все равно нет. Не приятно. А с учетом того, что мой ноутбук всегда и везде со мной. То я могу его где то забыть, потерять да и банальную кражу тоже никто не отменял. И если за свой телефон и планшет по этому поводу я не переживал, все таки там биометрия и шифрование, то ноутбук давал мне повод для беспокойства. Шифрования у меня там не было.</p>
   <p>А так как последние лет десять я сидел под ubuntu то меня заинтересовало, а как там дела с шифрованием обстоят в linux.</p>
   <p>Сразу оговорюсь. В первую очередь меня интересовала защита от случайных людей - сотрудников сервисных центров и мастерских, мамкиных хакеров и различных домашних аникейщиков. У меня нет задачи противостоять сотрудникам спецслужб, международным криминальным организациям и специалистам по криптографии. До этого, два раза, у меня был лайтовый опыт общения со следователями по уголовным делам и по этому, на свой счет, я иллюзий не испытываю.</p>
   <p>У меня установлена ubuntu 22.04 и все манипуляции я проводил на ней. Но я думаю, что эта инструкция подойдет и к любым другим дистрибутивам. Каких то специфических, дистрибутив зависимых вещей там нет.</p>
   <p>Итак, начал разбираться. Основной способ шифрования который сейчас предлагает при установке ubuntu и другие, это шифрование всего диска с помощью LUKS + LVM. Мне он не подошел. Во первых я не хотел переустанавливать ОС и во вторых я не хотел целиком шифровать весь диск. Для меня это слишком избыточный метод, я хотел шифровать только свою домашнюю папку. Хотя я знаю, что сейчас это наиболее правильный метод для защиты данных.</p>
   <p>Далее по популярности шло использование eCryptFS. Этот способ до 2018 года тоже предлагался в ubuntu при установке. Затем Canonical по различным причинам отказался от него. На данный момент проект то ли поддерживается, то ли не поддерживается. До конца я так и не понял.</p>
   <p>Поэтому я решил использовать fscrypt. Нативный метод шифрования для ext4. Разрабатывается и поддерживается google, используется в chromeOS и Android для шифрования. Ну, что еще надо.</p>
   <p>Поверхностное гугление выдало пару инструкций. Но судя по комментариям после одной из них компьютер уходил в цикличную перезагрузку, ну а вторая просто не работала. Пришлось идти на <a href="https://github.com/google/fscrypt" rel="noopener noreferrer nofollow">гитхаб</a> проекта и читать документацию.</p>
   <p>Итак, если вы хотите зашифровать свою домашнюю папку с&nbsp;помощью fscrypt на&nbsp;уже установленной операционке с&nbsp;файловой системой ext4:</p>
   <ol>
    <li><p>Включаем флаг шифрования на вашем устройстве</p></li>
   </ol>
   <pre><code class="bash">tune2fs -O encrypt /dev/ваш диск</code></pre>
   <ol start="2">
    <li><p>Устанавливаем инструменты для управления fscrypt и PAM модуль</p></li>
   </ol>
   <pre><code class="bash">apt install fscrypt libpam-fscrypt</code></pre>
   <ol start="3">
    <li><p>Создаем нового пользователя (например <strong>user1</strong>) и включаем его в группу <strong>sudo</strong>. Так как мы далее будем проводить манипуляции с нашей домашней папкой, то делать это лучше всего из под другого пользователя. Завершаем сеанс нашего основного пользователя (например <strong>user0</strong>) и заходим нашим новым пользователем (<strong>user1</strong>). Дальше все действия выполняем под ним.</p></li>
    <li><p>Настраиваем fscrypt</p></li>
   </ol>
   <pre><code class="bash">user1@laptop:# sudo fscrypt setup</code></pre>
   <p>будет создан конфигурационный файл</p>
   <pre><code class="bash">Created global config file at "/etc/fscrypt.conf".</code></pre>
   <p>и файл метаданных</p>
   <pre><code class="bash">Metadata directories created at "/.fscrypt"</code></pre>
   <p>на запрос создания файла метаданных в корне ./ нажимаем <strong>Y</strong><br></p>
   <p>5. Создаем новую домашнюю папку user0-new</p>
   <pre><code class="bash">user1@laptop:# sudo mkdir /home/user0-new</code></pre>
   <ol start="6">
    <li><p>Включаем шифрование этой папки</p></li>
   </ol>
   <pre><code class="bash">user1@laptop:# sudo fscrypt encrypt /home/user0-new --user=user0(ваш основной пользователь)</code></pre>
   <ol start="7">
    <li><p>В появившемся диалоге выбираем <strong>1</strong>. Т.е для дешифровки папки будет использоваться ваш пароль для логина в системе. И вводим пароль вашего основного пользователя(<strong>user0</strong>)</p></li>
   </ol>
   <pre><code class="bash">The following protector sources are available:
1 - Your login passphrase (pam_passphrase)
2 - A custom passphrase (custom_passphrase)
3 - A raw 256-bit key (raw_key)
Enter the source number for the new protector [2 - custom_passphrase]: 1

IMPORTANT: Before continuing, ensure you have properly set up your system for
           login protectors.  See
           https://github.com/google/fscrypt#setting-up-for-login-protectors

Enter login passphrase for user0:
"user0-new" is now encrypted, unlocked, and ready for use.
</code></pre>
   <ol start="8">
    <li><p>Все папка создана и зашифрована. Теперь копируем в нее все данные из старой домашней папки</p></li>
   </ol>
   <pre><code class="bash">user1@laptop:#sudo cp -a -T /home/user0 /home/user0-new
</code></pre>
   <ol start="9">
    <li><p>Переименовываем старую домашнюю папку</p></li>
   </ol>
   <pre><code class="bash">user1@laptop:# sudo mv user0 user0.backup
</code></pre>
   <ol start="10">
    <li><p>Переименовываем новую шифрованную домашнюю папку</p></li>
   </ol>
   <pre><code class="bash">user1@laptop:# sudo mv user0-new user0
</code></pre>
   <p>Все готово. Перезагружаемся и заходим вашим основным пользователем (<strong>user0</strong>). Если все нормально, то удаляем нового пользователя и папку с бекапом (<strong>user0.backup</strong>).</p>
   <p></p>
  </div>
 </div>
</div> <!----> <!---->